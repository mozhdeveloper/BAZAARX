CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "vector"; -- For AI image search embeddings

-- ============================================================================
-- DROP EXISTING OBJECTS (Reverse Dependency Order)
-- ============================================================================
-- Drop materialized views first
DROP MATERIALIZED VIEW IF EXISTS registry_item_fulfillment CASCADE;
DROP MATERIALIZED VIEW IF EXISTS voucher_statistics CASCADE;
DROP MATERIALIZED VIEW IF EXISTS seller_statistics CASCADE;
DROP MATERIALIZED VIEW IF EXISTS product_statistics CASCADE;
-- Drop helper views
DROP VIEW IF EXISTS conversation_with_last_message CASCADE;
DROP VIEW IF EXISTS product_detail_view CASCADE;
DROP VIEW IF EXISTS user_profile_complete CASCADE;
DROP VIEW IF EXISTS product_assessment_status_view CASCADE;
-- Drop all triggers
-- DROP TRIGGER IF EXISTS update_seller_stats_orders ON orders CASCADE;
-- DROP TRIGGER IF EXISTS update_seller_stats_reviews ON reviews CASCADE;
-- DROP TRIGGER IF EXISTS update_product_stats_orders ON order_items CASCADE;
-- DROP TRIGGER IF EXISTS update_product_stats_reviews ON reviews CASCADE;
-- DROP TRIGGER IF EXISTS update_updated_at_order_items ON order_items CASCADE;
-- DROP TRIGGER IF EXISTS update_updated_at_orders ON orders CASCADE;
-- DROP TRIGGER IF EXISTS update_updated_at_cart_items ON cart_items CASCADE;
-- DROP TRIGGER IF EXISTS update_updated_at_carts ON carts CASCADE;
-- DROP TRIGGER IF EXISTS update_updated_at_reviews ON reviews CASCADE;
-- DROP TRIGGER IF EXISTS update_updated_at_variants ON product_variants CASCADE;
-- DROP TRIGGER IF EXISTS update_updated_at_products ON products CASCADE;
-- DROP TRIGGER IF EXISTS update_updated_at_categories ON categories CASCADE;
-- DROP TRIGGER IF EXISTS update_updated_at_payment_methods ON payment_methods CASCADE;
-- DROP TRIGGER IF EXISTS update_updated_at_addresses ON addresses CASCADE;
-- DROP TRIGGER IF EXISTS update_updated_at_admins ON admins CASCADE;
-- DROP TRIGGER IF EXISTS update_updated_at_sellers ON sellers CASCADE;
-- DROP TRIGGER IF EXISTS update_updated_at_buyers ON buyers CASCADE;
-- DROP TRIGGER IF EXISTS update_updated_at_profiles ON profiles CASCADE;
-- Drop functions
DROP FUNCTION IF EXISTS refresh_seller_stats() CASCADE;
DROP FUNCTION IF EXISTS refresh_product_stats() CASCADE;
DROP FUNCTION IF EXISTS update_updated_at_column() CASCADE;
-- Drop tables in reverse dependency order
DROP TABLE IF EXISTS discount_usage CASCADE;
DROP TABLE IF EXISTS order_discounts CASCADE;
DROP TABLE IF EXISTS order_vouchers CASCADE;
DROP TABLE IF EXISTS order_promos CASCADE;
DROP TABLE IF EXISTS order_payments CASCADE;
DROP TABLE IF EXISTS order_shipments CASCADE;
DROP TABLE IF EXISTS order_cancellations CASCADE;
DROP TABLE IF EXISTS refund_return_periods CASCADE;
DROP TABLE IF EXISTS buyer_vouchers CASCADE;
DROP TABLE IF EXISTS product_revisions CASCADE;
DROP TABLE IF EXISTS product_rejections CASCADE;
DROP TABLE IF EXISTS product_approvals CASCADE;
DROP TABLE IF EXISTS product_assessment_logistics CASCADE;
DROP TABLE IF EXISTS product_assessments CASCADE;
DROP TABLE IF EXISTS ticket_messages CASCADE;
DROP TABLE IF EXISTS support_tickets CASCADE;
DROP TABLE IF EXISTS ticket_categories CASCADE;
DROP TABLE IF EXISTS messages CASCADE;
DROP TABLE IF EXISTS conversations CASCADE;
DROP TABLE IF EXISTS store_followers CASCADE;
DROP TABLE IF EXISTS shop_followers CASCADE;
DROP TABLE IF EXISTS low_stock_alerts CASCADE;
DROP TABLE IF EXISTS inventory_ledger CASCADE;
DROP TABLE IF EXISTS product_qa CASCADE;
DROP TABLE IF EXISTS review_images CASCADE;
DROP TABLE IF EXISTS reviews CASCADE;
DROP TABLE IF EXISTS order_status_history CASCADE;
DROP TABLE IF EXISTS order_items CASCADE;
DROP TABLE IF EXISTS orders CASCADE;
DROP TABLE IF EXISTS order_recipients CASCADE;
DROP TABLE IF EXISTS registry_items CASCADE;
DROP TABLE IF EXISTS registries CASCADE;
DROP TABLE IF EXISTS cart_items CASCADE;
DROP TABLE IF EXISTS carts CASCADE;
DROP TABLE IF EXISTS product_tags CASCADE;
DROP TABLE IF EXISTS product_colors CASCADE;
DROP TABLE IF EXISTS product_sizes CASCADE;
DROP TABLE IF EXISTS product_images CASCADE;
DROP TABLE IF EXISTS product_variants CASCADE;
DROP TABLE IF EXISTS products CASCADE;
DROP TABLE IF EXISTS seller_categories CASCADE;
DROP TABLE IF EXISTS categories CASCADE;
DROP TABLE IF EXISTS payment_method_wallets CASCADE;
DROP TABLE IF EXISTS payment_method_banks CASCADE;
DROP TABLE IF EXISTS payment_method_cards CASCADE;
DROP TABLE IF EXISTS payment_methods CASCADE;
DROP TABLE IF EXISTS shipping_addresses CASCADE;
DROP TABLE IF EXISTS addresses CASCADE;
DROP TABLE IF EXISTS admin_notifications CASCADE;
DROP TABLE IF EXISTS seller_notifications CASCADE;
DROP TABLE IF EXISTS buyer_notifications CASCADE;
DROP TABLE IF EXISTS notifications CASCADE;
DROP TABLE IF EXISTS seller_verification_documents CASCADE;
DROP TABLE IF EXISTS seller_payout_accounts CASCADE;
DROP TABLE IF EXISTS seller_business_profiles CASCADE;
DROP TABLE IF EXISTS seller_rejections CASCADE;
DROP TABLE IF EXISTS admin_audit_logs CASCADE;
DROP TABLE IF EXISTS admins CASCADE;
DROP TABLE IF EXISTS buyers CASCADE;
DROP TABLE IF EXISTS sellers CASCADE;
DROP TABLE IF EXISTS user_roles CASCADE;
DROP TABLE IF EXISTS profiles CASCADE;
DROP TABLE IF EXISTS product_discounts CASCADE;
DROP TABLE IF EXISTS discount_campaigns CASCADE;
DROP TABLE IF EXISTS voucher_usage CASCADE;
DROP TABLE IF EXISTS vouchers CASCADE;

-- ============================================================================
-- CORE IDENTITY TABLES
-- ============================================================================
-- Base user profile table (all users start here)
-- CRITICAL: This references auth.users which exists in Supabase
CREATE TABLE public.profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT NOT NULL UNIQUE,
  first_name TEXT,
  last_name TEXT,
  phone TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  last_login_at TIMESTAMPTZ,
  CONSTRAINT valid_email CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$')
);
COMMENT ON TABLE public.profiles IS 'Base user profile table - all users have an entry here';
COMMENT ON COLUMN public.profiles.id IS 'References auth.users - single source of authentication';
-- Enable Row Level Security (RLS) for Supabase
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
-- Multi-role support junction table
CREATE TABLE public.user_roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  role TEXT NOT NULL CHECK (role IN ('buyer', 'seller', 'admin')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE(user_id, role)
);
COMMENT ON TABLE public.user_roles IS 'Multi-role junction table - users can be buyer AND seller simultaneously';
ALTER TABLE public.user_roles ENABLE ROW LEVEL SECURITY;
-- Buyers table
CREATE TABLE public.buyers (
  id UUID PRIMARY KEY REFERENCES public.profiles(id) ON DELETE CASCADE,
  avatar_url TEXT,
  preferences JSONB DEFAULT '{}',
  bazcoins INTEGER NOT NULL DEFAULT 0 CHECK (bazcoins >= 0),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.buyers IS 'Buyer-specific data - linked via user_roles';
ALTER TABLE public.buyers ENABLE ROW LEVEL SECURITY;
-- Sellers table
CREATE TABLE public.sellers (
  id UUID PRIMARY KEY REFERENCES public.profiles(id) ON DELETE CASCADE,
  store_name TEXT NOT NULL UNIQUE,
  store_description TEXT,
  avatar_url TEXT,
  owner_name TEXT,
  approval_status TEXT NOT NULL DEFAULT 'pending' CHECK (approval_status IN ('pending', 'verified', 'rejected')),
  verified_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.sellers IS 'Seller-specific business data - linked via user_roles';
ALTER TABLE public.sellers ENABLE ROW LEVEL SECURITY;
-- Seller business profile
CREATE TABLE public.seller_business_profiles (
  seller_id UUID PRIMARY KEY REFERENCES public.sellers(id) ON DELETE CASCADE,
  business_type TEXT CHECK (business_type IN ('sole_proprietor', 'partnership', 'corporation')),
  business_registration_number TEXT,
  tax_id_number TEXT,
  address_line_1 TEXT,
  address_line_2 TEXT,
  city TEXT,
  province TEXT,
  postal_code TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.seller_business_profiles IS 'Seller business registration and address data';
ALTER TABLE public.seller_business_profiles ENABLE ROW LEVEL SECURITY;
-- Seller payout accounts
CREATE TABLE public.seller_payout_accounts (
  seller_id UUID PRIMARY KEY REFERENCES public.sellers(id) ON DELETE CASCADE,
  bank_name TEXT,
  account_name TEXT,
  account_number TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.seller_payout_accounts IS 'Seller payout banking details';
ALTER TABLE public.seller_payout_accounts ENABLE ROW LEVEL SECURITY;
-- Seller verification documents
CREATE TABLE public.seller_verification_documents (
  seller_id UUID PRIMARY KEY REFERENCES public.sellers(id) ON DELETE CASCADE,
  business_permit_url TEXT,
  valid_id_url TEXT,
  proof_of_address_url TEXT,
  dti_registration_url TEXT,
  tax_id_url TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.seller_verification_documents IS 'Seller verification document URLs';
ALTER TABLE public.seller_verification_documents ENABLE ROW LEVEL SECURITY;
-- Admins table
CREATE TABLE public.admins (
  id UUID PRIMARY KEY REFERENCES public.profiles(id) ON DELETE CASCADE,
  permissions JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.admins IS 'Platform administrator data';
ALTER TABLE public.admins ENABLE ROW LEVEL SECURITY;
-- Seller rejections
CREATE TABLE public.seller_rejections (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  description TEXT NOT NULL,
  created_by UUID REFERENCES public.admins(id) ON DELETE SET NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.seller_rejections IS 'Seller rejection reasons with admin audit trail';
ALTER TABLE public.seller_rejections ENABLE ROW LEVEL SECURITY;
-- Admin audit log
CREATE TABLE public.admin_audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  admin_id UUID NOT NULL REFERENCES public.admins(id) ON DELETE SET NULL,
  action TEXT NOT NULL,
  target_table TEXT,
  target_id UUID,
  old_values JSONB,
  new_values JSONB,
  ip_address TEXT,
  user_agent TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.admin_audit_logs IS 'Immutable audit trail for admin actions';
ALTER TABLE public.admin_audit_logs ENABLE ROW LEVEL SECURITY;

-- ============================================================================
-- USER-RELATED TABLES
-- ============================================================================
-- Normalized shipping addresses table
CREATE TABLE public.shipping_addresses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  label TEXT NOT NULL,
  address_line_1 TEXT NOT NULL,
  address_line_2 TEXT,
  barangay TEXT,
  city TEXT NOT NULL,
  province TEXT NOT NULL,
  region TEXT NOT NULL,
  postal_code TEXT NOT NULL,
  landmark TEXT,
  delivery_instructions TEXT,
  is_default BOOLEAN NOT NULL DEFAULT FALSE,
  address_type TEXT NOT NULL DEFAULT 'residential' CHECK (address_type IN ('residential', 'commercial')),
  coordinates JSONB,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.shipping_addresses IS 'Normalized shipping address book';
ALTER TABLE public.shipping_addresses ENABLE ROW LEVEL SECURITY;
-- Payment methods table
CREATE TABLE public.payment_methods (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  payment_type TEXT NOT NULL CHECK (payment_type IN ('card', 'bank_transfer', 'e_wallet', 'cod')),
  label TEXT NOT NULL,
  is_default BOOLEAN NOT NULL DEFAULT FALSE,
  is_verified BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.payment_methods IS 'Normalized payment methods';
ALTER TABLE public.payment_methods ENABLE ROW LEVEL SECURITY;
-- Payment method card details
CREATE TABLE public.payment_method_cards (
  payment_method_id UUID PRIMARY KEY REFERENCES public.payment_methods(id) ON DELETE CASCADE,
  card_last4 TEXT,
  card_brand TEXT,
  expiry_month INTEGER CHECK (expiry_month BETWEEN 1 AND 12),
  expiry_year INTEGER CHECK (expiry_year >= 2024)
);
COMMENT ON TABLE public.payment_method_cards IS 'Card payment method details';
ALTER TABLE public.payment_method_cards ENABLE ROW LEVEL SECURITY;
-- Payment method bank details
CREATE TABLE public.payment_method_banks (
  payment_method_id UUID PRIMARY KEY REFERENCES public.payment_methods(id) ON DELETE CASCADE,
  bank_name TEXT,
  account_number_last4 TEXT
);
COMMENT ON TABLE public.payment_method_banks IS 'Bank transfer payment details';
ALTER TABLE public.payment_method_banks ENABLE ROW LEVEL SECURITY;
-- Payment method e-wallet details
CREATE TABLE public.payment_method_wallets (
  payment_method_id UUID PRIMARY KEY REFERENCES public.payment_methods(id) ON DELETE CASCADE,
  e_wallet_provider TEXT,
  e_wallet_account_number TEXT
);
COMMENT ON TABLE public.payment_method_wallets IS 'E-wallet payment method details';
ALTER TABLE public.payment_method_wallets ENABLE ROW LEVEL SECURITY;
-- Notifications table
CREATE TABLE public.buyer_notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  buyer_id UUID NOT NULL REFERENCES public.buyers(id) ON DELETE CASCADE,
  type TEXT NOT NULL,
  title TEXT NOT NULL,
  message TEXT NOT NULL,
  action_url TEXT,
  action_data JSONB,
  read_at TIMESTAMPTZ,
  priority TEXT NOT NULL DEFAULT 'normal' CHECK (priority IN ('low', 'normal', 'high', 'urgent')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.buyer_notifications IS 'Buyer notifications';
ALTER TABLE public.buyer_notifications ENABLE ROW LEVEL SECURITY;
CREATE TABLE public.seller_notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  type TEXT NOT NULL,
  title TEXT NOT NULL,
  message TEXT NOT NULL,
  action_url TEXT,
  action_data JSONB,
  read_at TIMESTAMPTZ,
  priority TEXT NOT NULL DEFAULT 'normal' CHECK (priority IN ('low', 'normal', 'high', 'urgent')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.seller_notifications IS 'Seller notifications';
ALTER TABLE public.seller_notifications ENABLE ROW LEVEL SECURITY;
CREATE TABLE public.admin_notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  admin_id UUID NOT NULL REFERENCES public.admins(id) ON DELETE CASCADE,
  type TEXT NOT NULL,
  title TEXT NOT NULL,
  message TEXT NOT NULL,
  action_url TEXT,
  action_data JSONB,
  read_at TIMESTAMPTZ,
  priority TEXT NOT NULL DEFAULT 'normal' CHECK (priority IN ('low', 'normal', 'high', 'urgent')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.admin_notifications IS 'Admin notifications';
ALTER TABLE public.admin_notifications ENABLE ROW LEVEL SECURITY;

-- ============================================================================
-- CATEGORY SYSTEM
-- ============================================================================
CREATE TABLE public.categories (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL UNIQUE,
  slug TEXT NOT NULL UNIQUE,
  description TEXT,
  parent_id UUID REFERENCES public.categories(id) ON DELETE SET NULL,
  icon TEXT,
  image_url TEXT,
  sort_order INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT valid_slug CHECK (slug ~ '^[a-z0-9-]+$')
);
COMMENT ON TABLE public.categories IS 'Hierarchical product category system';
ALTER TABLE public.categories ENABLE ROW LEVEL SECURITY;
-- Seller categories junction table
CREATE TABLE public.seller_categories (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  seller_id UUID NOT NULL REFERENCES public.sellers(id) ON DELETE CASCADE,
  category_id UUID NOT NULL REFERENCES public.categories(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE(seller_id, category_id)
);
COMMENT ON TABLE public.seller_categories IS 'Seller-category relationships';
ALTER TABLE public.seller_categories ENABLE ROW LEVEL SECURITY;

-- ============================================================================
-- PRODUCT SYSTEM
-- ============================================================================
-- Main products table
CREATE TABLE public.products (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  description TEXT,
  category_id UUID NOT NULL REFERENCES public.categories(id) ON DELETE RESTRICT,
  brand TEXT,
  sku TEXT UNIQUE,
  specifications JSONB DEFAULT '{}',
  approval_status TEXT NOT NULL DEFAULT 'pending' CHECK (approval_status IN ('pending', 'approved', 'rejected', 'reclassified')),
  variant_label_1 TEXT,
  variant_label_2 TEXT,
  price NUMERIC NOT NULL CHECK (price >= 0),
  low_stock_threshold INTEGER NOT NULL DEFAULT 10 CHECK (low_stock_threshold >= 0),
  weight NUMERIC CHECK (weight > 0),
  dimensions JSONB,
  is_free_shipping BOOLEAN NOT NULL DEFAULT FALSE,
  disabled_at TIMESTAMPTZ,
  deleted_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  image_embedding VECTOR(1152)
);
COMMENT ON TABLE public.products IS 'Main product catalog - fully normalized';
ALTER TABLE public.products ENABLE ROW LEVEL SECURITY;
-- Product images table
CREATE TABLE public.product_images (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id UUID NOT NULL REFERENCES public.products(id) ON DELETE CASCADE,
  image_url TEXT NOT NULL,
  alt_text TEXT,
  sort_order INTEGER NOT NULL DEFAULT 0,
  is_primary BOOLEAN NOT NULL DEFAULT FALSE,
  uploaded_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT valid_url CHECK (image_url ~ '^https?://')
);
COMMENT ON TABLE public.product_images IS 'Product images with ordering';
ALTER TABLE public.product_images ENABLE ROW LEVEL SECURITY;
-- Product sizes junction table
-- Product colors junction table
-- Product tags junction table
CREATE TABLE public.product_tags (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id UUID NOT NULL REFERENCES public.products(id) ON DELETE CASCADE,
  tag TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE(product_id, tag),
  CONSTRAINT valid_tag CHECK (tag ~ '^[a-z0-9-]+$')
);
COMMENT ON TABLE public.product_tags IS 'Product tags';
ALTER TABLE public.product_tags ENABLE ROW LEVEL SECURITY;
-- Product variants table
CREATE TABLE public.product_variants (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id UUID NOT NULL REFERENCES public.products(id) ON DELETE CASCADE,
  sku TEXT NOT NULL UNIQUE,
  barcode TEXT UNIQUE,
  variant_name TEXT NOT NULL,
  size TEXT,
  color TEXT,
  option_1_value TEXT,
  option_2_value TEXT,
  price NUMERIC NOT NULL CHECK (price >= 0),
  stock INTEGER NOT NULL DEFAULT 0 CHECK (stock >= 0),
  thumbnail_url TEXT,
  embedding VECTOR(1152),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.product_variants IS 'Product variants with barcode support for POS';
ALTER TABLE public.product_variants ENABLE ROW LEVEL SECURITY;
-- Inventory ledger
-- Low stock alerts
CREATE TABLE public.low_stock_alerts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id UUID NOT NULL REFERENCES public.products(id) ON DELETE CASCADE,
  threshold INTEGER NOT NULL CHECK (threshold >= 0),
  acknowledged BOOLEAN NOT NULL DEFAULT FALSE,
  acknowledged_by UUID REFERENCES public.profiles(id) ON DELETE SET NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.low_stock_alerts IS 'Automated inventory alerts';
ALTER TABLE public.low_stock_alerts ENABLE ROW LEVEL SECURITY;
-- Product assessments
CREATE TABLE public.product_assessments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id UUID NOT NULL REFERENCES public.products(id) ON DELETE CASCADE,
  status TEXT NOT NULL DEFAULT 'pending_digital_review' CHECK (status IN (
  'pending_digital_review', 'waiting_for_sample', 'pending_physical_review',
  'verified', 'for_revision', 'rejected'
  )),
  submitted_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  verified_at TIMESTAMPTZ,
  revision_requested_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.product_assessments IS 'Quality assurance workflow';
ALTER TABLE public.product_assessments ENABLE ROW LEVEL SECURITY;
-- Product assessment logistics
CREATE TABLE public.product_assessment_logistics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  assessment_id UUID NOT NULL REFERENCES public.product_assessments(id) ON DELETE CASCADE,
  details TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by UUID REFERENCES public.admins(id) ON DELETE SET NULL
);
COMMENT ON TABLE public.product_assessment_logistics IS 'Assessment logistics and notes';
ALTER TABLE public.product_assessment_logistics ENABLE ROW LEVEL SECURITY;
-- Product approvals
CREATE TABLE public.product_approvals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  assessment_id UUID NOT NULL REFERENCES public.product_assessments(id) ON DELETE CASCADE,
  description TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by UUID REFERENCES public.admins(id) ON DELETE SET NULL
);
COMMENT ON TABLE public.product_approvals IS 'Product approval events';
ALTER TABLE public.product_approvals ENABLE ROW LEVEL SECURITY;
-- Product rejections
CREATE TABLE public.product_rejections (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  assessment_id UUID REFERENCES public.product_assessments(id) ON DELETE CASCADE,
  product_id UUID REFERENCES public.products(id) ON DELETE CASCADE,
  description TEXT,
  vendor_submitted_category TEXT,
  admin_reclassified_category TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by UUID REFERENCES public.admins(id) ON DELETE SET NULL,
  CONSTRAINT product_rejection_subject CHECK (assessment_id IS NOT NULL OR product_id IS NOT NULL)
);
COMMENT ON TABLE public.product_rejections IS 'Product rejection events and reclassification metadata';
ALTER TABLE public.product_rejections ENABLE ROW LEVEL SECURITY;
-- Product revisions
CREATE TABLE public.product_revisions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  assessment_id UUID NOT NULL REFERENCES public.product_assessments(id) ON DELETE CASCADE,
  description TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by UUID REFERENCES public.admins(id) ON DELETE SET NULL
);
COMMENT ON TABLE public.product_revisions IS 'Product revision requests';
ALTER TABLE public.product_revisions ENABLE ROW LEVEL SECURITY;
-- Product assessment status view
CREATE VIEW public.product_assessment_status_view AS
WITH events AS (
SELECT assessment_id,
'approved'::TEXT AS last_status,
created_at AS last_status_at,
created_by AS last_status_by,
'approval'::TEXT AS last_status_type
FROM public.product_approvals
UNION ALL
SELECT assessment_id,
'rejected'::TEXT AS last_status,
created_at AS last_status_at,
created_by AS last_status_by,
'rejection'::TEXT AS last_status_type
FROM public.product_rejections
WHERE assessment_id IS NOT NULL
UNION ALL
SELECT assessment_id,
'for_revision'::TEXT AS last_status,
created_at AS last_status_at,
created_by AS last_status_by,
'revision'::TEXT AS last_status_type
FROM public.product_revisions
)
SELECT assessment_id, last_status, last_status_at, last_status_by, last_status_type
FROM (
SELECT *,
ROW_NUMBER() OVER (PARTITION BY assessment_id ORDER BY last_status_at DESC) AS rn
FROM events
) ranked
WHERE rn = 1;

-- ============================================================================
-- REVIEWS SYSTEM
-- ============================================================================
CREATE TABLE public.reviews (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id UUID NOT NULL REFERENCES public.products(id) ON DELETE CASCADE,
  buyer_id UUID NOT NULL REFERENCES public.buyers(id) ON DELETE CASCADE,
  order_id UUID,
  rating INTEGER NOT NULL CHECK (rating BETWEEN 1 AND 5),
  comment TEXT,
  helpful_count INTEGER NOT NULL DEFAULT 0 CHECK (helpful_count >= 0),
  seller_reply JSONB,
  is_verified_purchase BOOLEAN NOT NULL DEFAULT FALSE,
  is_hidden BOOLEAN NOT NULL DEFAULT FALSE,
  is_edited BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.reviews IS 'Product reviews';
ALTER TABLE public.reviews ENABLE ROW LEVEL SECURITY;
-- Review images table
CREATE TABLE public.review_images (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  review_id UUID NOT NULL REFERENCES public.reviews(id) ON DELETE CASCADE,
  image_url TEXT NOT NULL,
  sort_order INTEGER NOT NULL DEFAULT 0,
  uploaded_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT valid_url CHECK (image_url ~ '^https?://')
);
COMMENT ON TABLE public.review_images IS 'Review images';
ALTER TABLE public.review_images ENABLE ROW LEVEL SECURITY;

-- ============================================================================
-- SHOPPING CART SYSTEM
-- ============================================================================
CREATE TABLE public.carts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  buyer_id UUID REFERENCES public.buyers(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.carts IS 'Shopping cart';
ALTER TABLE public.carts ENABLE ROW LEVEL SECURITY;
CREATE TABLE public.cart_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  cart_id UUID NOT NULL REFERENCES public.carts(id) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES public.products(id) ON DELETE CASCADE,
  variant_id UUID REFERENCES public.product_variants(id) ON DELETE SET NULL,
  quantity INTEGER NOT NULL DEFAULT 1 CHECK (quantity > 0),
  personalized_options JSONB,
  notes TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.cart_items IS 'Cart line items';
ALTER TABLE public.cart_items ENABLE ROW LEVEL SECURITY;

-- ============================================================================
-- GIFT REGISTRY SYSTEM
-- ============================================================================
CREATE TABLE public.registries (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  buyer_id UUID NOT NULL REFERENCES public.buyers(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  description TEXT,
  event_type TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.registries IS 'Privacy-first gift registry';
ALTER TABLE public.registries ENABLE ROW LEVEL SECURITY;
CREATE TABLE public.registry_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  registry_id UUID NOT NULL REFERENCES public.registries(id) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES public.products(id) ON DELETE CASCADE,
  quantity_desired INTEGER NOT NULL CHECK (quantity_desired > 0),
  priority TEXT NOT NULL DEFAULT 'medium' CHECK (priority IN ('low', 'medium', 'high')),
  notes TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.registry_items IS 'Registry wish items';
ALTER TABLE public.registry_items ENABLE ROW LEVEL SECURITY;

-- ============================================================================
-- ORDER SYSTEM (Create vouchers table first as orders references it)
-- ============================================================================
CREATE TABLE public.vouchers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code TEXT NOT NULL UNIQUE,
  title TEXT NOT NULL,
  description TEXT,
  voucher_type TEXT NOT NULL CHECK (voucher_type IN ('percentage', 'fixed', 'shipping')),
  value NUMERIC NOT NULL CHECK (value > 0),
  min_order_value NUMERIC NOT NULL DEFAULT 0 CHECK (min_order_value >= 0),
  max_discount NUMERIC CHECK (max_discount > 0),
  seller_id UUID REFERENCES public.sellers(id) ON DELETE CASCADE,
  claimable_from TIMESTAMPTZ NOT NULL,
  claimable_until TIMESTAMPTZ NOT NULL,
  usage_limit INTEGER CHECK (usage_limit > 0),
  claim_limit INTEGER,
  duration INTERVAL,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT valid_dates CHECK (claimable_until > claimable_from)
);
COMMENT ON TABLE public.vouchers IS 'Promotional vouchers';
ALTER TABLE public.vouchers ENABLE ROW LEVEL SECURITY;
CREATE TABLE public.buyer_vouchers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  buyer_id UUID NOT NULL REFERENCES public.buyers(id) ON DELETE CASCADE,
  voucher_id UUID NOT NULL REFERENCES public.vouchers(id) ON DELETE CASCADE,
  valid_from TIMESTAMPTZ,
  valid_until TIMESTAMPTZ,
  usage_count INTEGER NOT NULL DEFAULT 0 CHECK (usage_count >= 0),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.buyer_vouchers IS 'Buyer-claimed vouchers';
ALTER TABLE public.buyer_vouchers ENABLE ROW LEVEL SECURITY;
CREATE TABLE public.order_recipients (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  first_name TEXT,
  last_name TEXT,
  phone TEXT,
  email TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.order_recipients IS 'Order recipient details';
ALTER TABLE public.order_recipients ENABLE ROW LEVEL SECURITY;
-- Now create orders table
CREATE TABLE public.orders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_number TEXT NOT NULL UNIQUE,
  buyer_id UUID NOT NULL REFERENCES public.buyers(id) ON DELETE RESTRICT,
  order_type TEXT NOT NULL DEFAULT 'ONLINE' CHECK (order_type IN ('ONLINE', 'OFFLINE')),
  pos_note TEXT,
  recipient_id UUID REFERENCES public.order_recipients(id) ON DELETE SET NULL,
  address_id UUID REFERENCES public.shipping_addresses(id) ON DELETE SET NULL,
  payment_status TEXT NOT NULL DEFAULT 'pending_payment' CHECK (payment_status IN (
  'pending_payment', 'paid', 'refunded', 'partially_refunded'
  )),
  shipment_status TEXT NOT NULL DEFAULT 'waiting_for_seller' CHECK (shipment_status IN (
  'waiting_for_seller', 'processing', 'ready_to_ship', 'shipped', 'out_for_delivery',
  'delivered', 'failed_to_deliver', 'received', 'returned'
  )),
  paid_at TIMESTAMPTZ,
  notes TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.orders IS 'Order master table';
ALTER TABLE public.orders ENABLE ROW LEVEL SECURITY;
-- Add FK to reviews.order_id now that orders table exists
ALTER TABLE public.reviews ADD CONSTRAINT reviews_order_id_fkey
FOREIGN KEY (order_id) REFERENCES public.orders(id) ON DELETE SET NULL;
CREATE TABLE public.order_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_id UUID NOT NULL REFERENCES public.orders(id) ON DELETE CASCADE,
  product_id UUID REFERENCES public.products(id) ON DELETE SET NULL,
  product_name TEXT NOT NULL,
  primary_image_url TEXT,
  price NUMERIC NOT NULL CHECK (price >= 0),
  price_discount NUMERIC NOT NULL DEFAULT 0 CHECK (price_discount >= 0),
  shipping_price NUMERIC NOT NULL DEFAULT 0 CHECK (shipping_price >= 0),
  shipping_discount NUMERIC NOT NULL DEFAULT 0 CHECK (shipping_discount >= 0),
  quantity INTEGER NOT NULL CHECK (quantity > 0),
  variant_id UUID REFERENCES public.product_variants(id) ON DELETE SET NULL,
  personalized_options JSONB,
  rating INTEGER CHECK (rating BETWEEN 1 AND 5),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.order_items IS 'Order line items';
ALTER TABLE public.order_items ENABLE ROW LEVEL SECURITY;
CREATE TABLE public.order_shipments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_id UUID NOT NULL REFERENCES public.orders(id) ON DELETE CASCADE,
  status TEXT NOT NULL,
  shipping_method JSONB,
  tracking_number TEXT,
  shipped_at TIMESTAMPTZ,
  delivered_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.order_shipments IS 'Order shipment records';
ALTER TABLE public.order_shipments ENABLE ROW LEVEL SECURITY;
CREATE TABLE public.order_payments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_id UUID NOT NULL REFERENCES public.orders(id) ON DELETE CASCADE,
  payment_method JSONB,
  payment_reference TEXT,
  payment_date TIMESTAMPTZ,
  amount NUMERIC NOT NULL CHECK (amount >= 0),
  status TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.order_payments IS 'Order payment records';
ALTER TABLE public.order_payments ENABLE ROW LEVEL SECURITY;
CREATE TABLE public.order_promos (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_id UUID NOT NULL REFERENCES public.orders(id) ON DELETE CASCADE,
  promo_code TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.order_promos IS 'Order promo code applications';
ALTER TABLE public.order_promos ENABLE ROW LEVEL SECURITY;
CREATE TABLE public.order_vouchers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  buyer_id UUID NOT NULL REFERENCES public.buyers(id) ON DELETE CASCADE,
  order_id UUID NOT NULL REFERENCES public.orders(id) ON DELETE CASCADE,
  voucher_id UUID NOT NULL REFERENCES public.vouchers(id) ON DELETE CASCADE,
  discount_amount NUMERIC NOT NULL DEFAULT 0 CHECK (discount_amount >= 0),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.order_vouchers IS 'Order voucher applications';
ALTER TABLE public.order_vouchers ENABLE ROW LEVEL SECURITY;
CREATE TABLE public.refund_return_periods (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_id UUID NOT NULL REFERENCES public.orders(id) ON DELETE CASCADE,
  is_returnable BOOLEAN NOT NULL DEFAULT TRUE,
  return_window_days INTEGER NOT NULL DEFAULT 7 CHECK (return_window_days >= 0),
  return_reason TEXT,
  refund_amount NUMERIC CHECK (refund_amount >= 0),
  refund_date TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.refund_return_periods IS 'Return and refund policy records';
ALTER TABLE public.refund_return_periods ENABLE ROW LEVEL SECURITY;
CREATE TABLE public.order_cancellations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_id UUID NOT NULL REFERENCES public.orders(id) ON DELETE CASCADE,
  reason TEXT,
  cancelled_at TIMESTAMPTZ,
  cancelled_by UUID REFERENCES public.profiles(id) ON DELETE SET NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.order_cancellations IS 'Order cancellation records';
ALTER TABLE public.order_cancellations ENABLE ROW LEVEL SECURITY;
CREATE TABLE public.order_status_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_id UUID NOT NULL REFERENCES public.orders(id) ON DELETE CASCADE,
  status TEXT NOT NULL,
  note TEXT,
  changed_by UUID REFERENCES public.profiles(id) ON DELETE SET NULL,
  changed_by_role TEXT,
  metadata JSONB,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.order_status_history IS 'Order timeline audit trail';
ALTER TABLE public.order_status_history ENABLE ROW LEVEL SECURITY;

-- ============================================================================
-- MESSAGING SYSTEM
-- ============================================================================
CREATE TABLE public.conversations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  buyer_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  order_id UUID REFERENCES public.orders(id) ON DELETE SET NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.conversations IS 'Buyer-seller conversations';
ALTER TABLE public.conversations ENABLE ROW LEVEL SECURITY;
CREATE TABLE public.messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  conversation_id UUID NOT NULL REFERENCES public.conversations(id) ON DELETE CASCADE,
  sender_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  sender_type TEXT NOT NULL CHECK (sender_type IN ('buyer', 'seller')),
  content TEXT NOT NULL,
  image_url TEXT,
  is_read BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.messages IS 'Conversation messages';
ALTER TABLE public.messages ENABLE ROW LEVEL SECURITY;

-- ============================================================================
-- SUPPORT TICKETING SYSTEM
CREATE TABLE public.ticket_categories (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  parent_id UUID REFERENCES public.ticket_categories(id) ON DELETE SET NULL,
  description TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.ticket_categories IS 'Support ticket category taxonomy';
ALTER TABLE public.ticket_categories ENABLE ROW LEVEL SECURITY;

-- ============================================================================
CREATE TABLE public.support_tickets (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  category_id UUID REFERENCES public.ticket_categories(id) ON DELETE SET NULL,
  priority TEXT NOT NULL DEFAULT 'normal' CHECK (priority IN ('low', 'normal', 'high', 'urgent')),
  status TEXT NOT NULL DEFAULT 'open' CHECK (status IN ('open', 'in_progress', 'waiting_response', 'resolved', 'closed')),
  subject TEXT NOT NULL,
  description TEXT NOT NULL,
  order_id UUID REFERENCES public.orders(id) ON DELETE SET NULL,
  assigned_to UUID REFERENCES public.admins(id) ON DELETE SET NULL,
  resolved_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.support_tickets IS 'Support ticketing system';
ALTER TABLE public.support_tickets ENABLE ROW LEVEL SECURITY;
CREATE TABLE public.ticket_messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  ticket_id UUID NOT NULL REFERENCES public.support_tickets(id) ON DELETE CASCADE,
  sender_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  sender_type TEXT NOT NULL CHECK (sender_type IN ('user', 'admin')),
  message TEXT NOT NULL,
  is_internal_note BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.ticket_messages IS 'Ticket conversation thread';
ALTER TABLE public.ticket_messages ENABLE ROW LEVEL SECURITY;

-- ============================================================================
-- SOCIAL FEATURES
-- ============================================================================
CREATE TABLE public.store_followers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  buyer_id UUID NOT NULL REFERENCES public.buyers(id) ON DELETE CASCADE,
  seller_id UUID NOT NULL REFERENCES public.sellers(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE(buyer_id, seller_id)
);
COMMENT ON TABLE public.store_followers IS 'Shop follower relationships';
ALTER TABLE public.store_followers ENABLE ROW LEVEL SECURITY;

-- ============================================================================
-- VOUCHER USAGE TRACKING
-- ============================================================================
-- ============================================================================
-- DISCOUNT CAMPAIGNS
-- ============================================================================
CREATE TABLE public.discount_campaigns (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  seller_id UUID NOT NULL REFERENCES public.sellers(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  description TEXT,
  campaign_type TEXT NOT NULL CHECK (campaign_type IN (
  'flash_sale', 'seasonal_sale', 'clearance', 'buy_more_save_more',
  'limited_time_offer', 'new_arrival_promo', 'bundle_deal'
  )),
  discount_type TEXT NOT NULL CHECK (discount_type IN ('percentage', 'fixed_amount')),
  discount_value NUMERIC NOT NULL CHECK (discount_value > 0),
  max_discount_amount NUMERIC CHECK (max_discount_amount > 0),
  min_purchase_amount NUMERIC NOT NULL DEFAULT 0 CHECK (min_purchase_amount >= 0),
  starts_at TIMESTAMPTZ NOT NULL,
  ends_at TIMESTAMPTZ NOT NULL,
  status TEXT NOT NULL DEFAULT 'scheduled' CHECK (status IN (
  'scheduled', 'active', 'paused', 'ended', 'cancelled'
  )),
  badge_text TEXT,
  badge_color TEXT DEFAULT '#FF6A00',
  priority INTEGER NOT NULL DEFAULT 0,
  claim_limit INTEGER CHECK (claim_limit > 0),
  per_customer_limit INTEGER NOT NULL DEFAULT 1 CHECK (per_customer_limit > 0),
  applies_to TEXT NOT NULL DEFAULT 'specific_products' CHECK (applies_to IN (
  'all_products', 'specific_products', 'specific_categories'
  )),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT valid_dates CHECK (ends_at > starts_at)
);
COMMENT ON TABLE public.discount_campaigns IS 'Campaign management';
ALTER TABLE public.discount_campaigns ENABLE ROW LEVEL SECURITY;
CREATE TABLE public.order_discounts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  buyer_id UUID NOT NULL REFERENCES public.buyers(id) ON DELETE CASCADE,
  order_id UUID NOT NULL REFERENCES public.orders(id) ON DELETE CASCADE,
  campaign_id UUID REFERENCES public.discount_campaigns(id) ON DELETE CASCADE,
  discount_amount NUMERIC NOT NULL DEFAULT 0 CHECK (discount_amount >= 0),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.order_discounts IS 'Order discount applications';
ALTER TABLE public.order_discounts ENABLE ROW LEVEL SECURITY;
CREATE TABLE public.product_discounts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  campaign_id UUID NOT NULL REFERENCES public.discount_campaigns(id) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES public.products(id) ON DELETE CASCADE,
  discount_type TEXT CHECK (discount_type IN ('percentage', 'fixed_amount')),
  discount_value NUMERIC CHECK (discount_value > 0),
  sold_count INTEGER NOT NULL DEFAULT 0 CHECK (sold_count >= 0),
  priority INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
COMMENT ON TABLE public.product_discounts IS 'Product-specific discounts';
ALTER TABLE public.product_discounts ENABLE ROW LEVEL SECURITY;

-- ============================================================================
-- END OF TABLE CREATION
-- Schema creation complete. Proceed to indexes...
-- ============================================================================
